#!/usr/bin/perl -w
######################################################################
#
# $Id: test_harness.local,v 1.2 2006/10/03 22:52:38 mavrik Exp $
#
######################################################################

use strict;

######################################################################
#
# GetTestNumber
#
######################################################################

sub GetTestNumber
{
  return "1";
}


######################################################################
#
# This hash controls the order in which tests are performed.
#
######################################################################

  my $phTestNumbers = GetTestNumbers();

  %$phTestNumbers =
  (
    1 => "file_1",
  );


######################################################################
#
# This hash holds test descriptions.
#
######################################################################

  my $phTestDescriptions = GetTestDescriptions();

  %$phTestDescriptions =
  (
    'file_1' => "tests a tar ball consisting of one file",
  );


######################################################################
#
# This hash holds various test properties.
#
######################################################################

  my $phTestProperties = GetTestProperties();


######################################################################
#
# TestGroup_file_1
#
######################################################################

sub Hitch_file_1
{
  1;
}


sub Check_file_1
{
  my ($phProperties) = @_;

  my ($sFile, $sName) = MakeTestName($phProperties);

  my $sCommand = "$$phProperties{'TargetProgram'} --map --file $sFile 2>&1";

  DebugPrint(3, "Command=$sCommand");

  if (!open(PH, "$sCommand |"))
  {
    return "fail";
  }
  binmode(PH);
  my @aLines = <PH>;
  close(PH);

  DebugPrint(4, "TargetLineCount=2");
  if (scalar(@aLines) != 2)
  {
    DebugPrint(4, "ActualLineCount=" . scalar(@aLines));
    return "fail";
  }
  $aLines[1] =~ s/[\r\n]*$//;

  my $sTargetOutputRegExp = qq("file_1"[|]6[|]ba9d332813a722b273a95fa13dd88d94[|]2b76b53cd6b8b98ee742c926277ea86625228451);
  DebugPrint(4, "TargetOutputRegExp=$sTargetOutputRegExp");
  if ($aLines[1] !~ /^$sTargetOutputRegExp$/)
  {
    DebugPrint(4, "ActualOutput=$aLines[1]");
    return "fail";
  }

  return "pass";
}


sub Clean_file_1
{
  my ($phProperties) = @_;

  my ($sFile, $sName) = MakeTestName($phProperties);

  if (-f $sFile && !unlink($sFile))
  {
    return "fail";
  }

  return "pass";
}


sub Setup_file_1
{
  my ($phProperties) = @_;

  my ($sFile, $sName) = MakeTestName($phProperties);

  if (!open(FH, "> $sFile"))
  {
    return "fail";
  }

  foreach my $sEncodedLine (split(/\n/, <<'EOF'))
begin 644 file_1.tar
M9FEL95\Q````````````````````````````````````````````````````
M````````````````````````````````````````````````````````````
M`````````````#`P,#8T-"``,#`P,30T(``P,#`Q-#0@`#`P,#`P,#`P,#`V
M(#$P-3$P-#8R-S,P(#`Q,C<T-@`@,```````````````````````````````
M````````````````````````````````````````````````````````````
M``````````````````````````````````````````!U<W1A<@`P,&UA=G)I
M:P``````````````````````````````````;6%V<FEK````````````````
M```````````````````P,#`P,#`@`#`P,#`P,"``````````````````````
M````````````````````````````````````````````````````````````
M````````````````````````````````````````````````````````````
M````````````````````````````````````````````````````````````
M``````````````````````!F:6QE7S$`````````````````````````````
M````````````````````````````````````````````````````````````
M````````````````````````````````````````````````````````````
M````````````````````````````````````````````````````````````
M````````````````````````````````````````````````````````````
M````````````````````````````````````````````````````````````
M````````````````````````````````````````````````````````````
M````````````````````````````````````````````````````````````
M````````````````````````````````````````````````````````````
M````````````````````````````````````````````````````````````
M````````````````````````````````````````````````````````````
M````````````````````````````````````````````````````````````
M````````````````````````````````````````````````````````````
M````````````````````````````````````````````````````````````
M````````````````````````````````````````````````````````````
M````````````````````````````````````````````````````````````
M````````````````````````````````````````````````````````````
M````````````````````````````````````````````````````````````
M````````````````````````````````````````````````````````````
M````````````````````````````````````````````````````````````
M````````````````````````````````````````````````````````````
M````````````````````````````````````````````````````````````
M````````````````````````````````````````````````````````````
M````````````````````````````````````````````````````````````
M````````````````````````````````````````````````````````````
M````````````````````````````````````````````````````````````
M````````````````````````````````````````````````````````````
M````````````````````````````````````````````````````````````
M````````````````````````````````````````````````````````````
M````````````````````````````````````````````````````````````
M````````````````````````````````````````````````````````````
M````````````````````````````````````````````````````````````
M````````````````````````````````````````````````````````````
M````````````````````````````````````````````````````````````
7````````````````````````````````
`
end
EOF
{
   next if ($sEncodedLine =~ /^begin/);
   last if ($sEncodedLine =~ /^end/);
   my $sLine = unpack("u", $sEncodedLine);
   print FH $sLine if (defined($sLine));
}

  return "pass";
}

1;
